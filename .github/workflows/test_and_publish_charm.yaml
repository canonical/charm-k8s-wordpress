name: Publish to edge

# On push to a "special" branch, we:
# * always publish to charmhub at latest/edge/branchname
# * always run tests
# where a "special" branch is one of main or track/**, as
# by convention these branches are the source for a corresponding
# charmhub edge channel.

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - track/**

jobs:
  integration-tests:
    uses: ./.github/workflows/integration_test.yaml
  test-and-publish-charm:
    needs: integration-tests
    uses: canonical/operator-workflows/.github/workflows/test_and_publish_charm.yaml
    with:
      integration-test-modules: '["test_core"]'
      integration-test-pre-run-script: |
        -c "sudo microk8s config > kube-config && \
        sudo microk8s enable registry hostpath-storage ingress && \
        tox -e test-build"
      integration-test-extra-arguments: |
        -m "not (require_secret)" \
        --openstack-rc ./openrc \
        --kube-config ./kube-config \
        --screenshot-dir /tmp \
        --test-db-from-config --num-units=3
